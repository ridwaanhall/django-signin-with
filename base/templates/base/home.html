{% extends 'base.html' %}
{% load socialaccount %}

{% block title %}Live Chat - Django Social{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <!-- Chat Section -->
    <div class="col-lg-8 col-xl-6">        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0 text-center">
                    <i class="bi bi-chat-dots me-2"></i>Live Chat
                    <span class="badge bg-light text-primary ms-2">{{ chat_messages.count }} messages</span>
                </h4>                {% if user.is_authenticated %}
                    <p class="text-center mb-0 mt-2 small">
                        <i class="bi bi-person-check me-1"></i>Signed in as {{ current_user_profile.full_name|default:user.username }}
                    </p>
                {% else %}
                    <p class="text-center mb-0 mt-2 small">
                        <i class="bi bi-info-circle me-1"></i>Sign in to participate
                    </p>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages -->
                <div id="chat-messages" class="p-3" style="height: 500px; overflow-y: auto;">
                    {% if chat_messages %}                        {% for message in chat_messages reversed %}
                            <div class="chat-message mb-3">
                                <div class="d-flex align-items-start">
                                    {% if message.user_profile_image %}
                                        <img src="{{ message.user_profile_image }}" alt="{{ message.user_full_name }}" 
                                             class="rounded-circle me-2" style="width: 32px; height: 32px; min-width: 32px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; min-width: 32px;">
                                            <i class="bi bi-person-fill text-white small"></i>
                                        </div>
                                    {% endif %}
                                    <div class="flex-grow-1">
                                        <div class="bg-light rounded-3 p-2">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="fw-bold text-primary">{{ message.user_full_name }}</small>
                                                <small class="text-muted">{{ message.timestamp|time:"H:i" }}</small>
                                            </div>
                                            <p class="mb-0 small">{{ message.message }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}{% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-dots fs-1 mb-3 text-primary"></i>
                            <h5 class="text-muted">Welcome to Live Chat!</h5>
                            <p>No messages yet. Be the first to say hello!</p>
                            {% if not user.is_authenticated %}
                                <a href="{% provider_login_url 'google' %}" class="btn btn-primary btn-sm mt-2">
                                    <i class="bi bi-google me-1"></i>Sign in with Google to start chatting
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Chat Input -->
                <div class="border-top p-3">
                    {% if user.is_authenticated %}
                        <form id="chat-form" class="d-flex gap-2">
                            {% csrf_token %}
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message..." maxlength="500" required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>                        <small class="text-muted">Press Enter to send â€¢ {{ chat_messages.count }} total messages</small>
                    {% else %}
                        <div class="text-center py-3">
                            <p class="text-muted mb-3">
                                <i class="bi bi-lock me-1"></i>Sign in to join the conversation
                            </p>
                            <a href="{% provider_login_url 'google' %}" class="btn btn-primary">
                                <i class="bi bi-google me-2"></i>Sign in with Google
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');

        // Auto-scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Initial scroll to bottom
        scrollToBottom();

        // Handle form submission
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                // Disable form while sending
                messageInput.disabled = true;
                const submitBtn = chatForm.querySelector('button[type="submit"]');
                const originalBtnContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                
                // Send message via AJAX
                fetch('{% url "send_message" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: 'message=' + encodeURIComponent(message)
                })
                .then(response => response.json())
                .then(data => {                    if (data.success) {
                        // Create profile image or default avatar
                        const avatarHtml = data.message.profile_image 
                            ? `<img src="${data.message.profile_image}" alt="${data.message.user}" 
                                 class="rounded-circle me-2" style="width: 32px; height: 32px; min-width: 32px; object-fit: cover;">`
                            : `<div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; min-width: 32px;">
                                 <i class="bi bi-person-fill text-white small"></i>
                               </div>`;
                        
                        // Add message to chat
                        const messageHtml = `
                            <div class="chat-message mb-3">
                                <div class="d-flex align-items-start">
                                    ${avatarHtml}
                                    <div class="flex-grow-1">
                                        <div class="bg-light rounded-3 p-2">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="fw-bold text-primary">${data.message.user}</small>
                                                <small class="text-muted">${data.message.timestamp}</small>
                                            </div>
                                            <p class="mb-0 small">${data.message.message}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Remove "no messages" placeholder if it exists
                        const noMessages = chatMessages.querySelector('.text-center.text-muted.py-5');
                        if (noMessages) {
                            noMessages.remove();
                        }
                        
                        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                        messageInput.value = '';
                        scrollToBottom();
                          // Update message count
                        const badge = document.querySelector('.badge.bg-light.text-primary');
                        if (badge) {
                            const currentCount = parseInt(badge.textContent.split(' ')[0]) || 0;
                            badge.textContent = `${currentCount + 1} messages`;
                        }
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to send message. Please try again.');
                })
                .finally(() => {
                    // Re-enable form
                    messageInput.disabled = false;
                    submitBtn.innerHTML = originalBtnContent;
                    messageInput.focus();
                });
            });
            
            // Handle Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }            });
        }

        // Auto-refresh chat every 30 seconds
        setInterval(function() {
            if (document.visibilityState === 'visible') {
                location.reload();
            }
        }, 30000);
    });
</script>

<style>
    .chat-message {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    #chat-messages {
        background: #f8f9fa;
    }
    
    #chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .btn {
        position: relative;
        overflow: hidden;
    }
</style>
{% endblock %}
